name: Update JIRA Confluence Page
on:
  pull_request:
    types:
      - opened
      - synchronize
      - closed
env:
  JIRA_USERNAME: ${{ secrets.JIRA_USERNAME }}
  JIRA_PASSWORD: ${{ secrets.JIRA_PASSWORD }}
  CONFLUENCE_URL: ${{ secrets.CONFLUENCE_URL }}
  
jobs:
  update_jira_confluence:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: installing jq
        run: sudo apt-get install jq
      - name : Get Pull Request Details
        run: |
          PR_TITLE=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                 https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }} | \
                 jq -r '.title')
          PR_DESCRIPTION=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                       https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }} | \
                       jq -r '.body')
        env:
          PR_TITLE: ${{ env.PR_TITLE }}
          PR_DESCRIPTION: ${{ env.PR_DESCRIPTION }}
      - name: Push Data to Confluence
        run: |
          PAGE_ID="<Confluence_Page_ID>"
          TABLE_CONTENT="||Title||Description||\n|${{ env.PR_TITLE }}|${{ env.PR_DESCRIPTION }}|"

          curl -s -u ${{ secrets.CONFLUENCE_USERNAME }}:${{ secrets.CONFLUENCE_API_TOKEN }} \
            -X PUT \
            -H "Content-Type: application/json" \
            -d '{
               "version": {
                 "number": <Current_Page_Version>
                  },
               "title": "<Page_Title>",
               "type": "page",
               "body": {
                 "storage": {
                 "value": "<table>${TABLE_CONTENT}</table>",
                 "representation": "storage"
                 }
               }
            }' \
          https://<your-domain>.atlassian.net/wiki/rest/api/content/${PAGE_ID}

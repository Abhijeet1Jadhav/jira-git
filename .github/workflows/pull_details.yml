name: Update JIRA
on:
  pull_request:
    types:
      - opened
      - synchronize
      - closed
env:
  JIRA_USERNAME: ${{ secrets.JIRA_USERNAME }}
  JIRA_PASSWORD: ${{ secrets.JIRA_PASSWORD }}
  CONFLUENCE_URL: ${{ secrets.CONFLUENCE_URL }}
  
jobs:
  update_jira_confluence:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: installing jq
        run: sudo apt-get install jq
      - name : Get Pull Request Details
        run: |
          PR_TITLE=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                 https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }} | \
                 jq -r '.title')
          PR_DESCRIPTION=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                       https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }} | \
                       jq -r '.body')
        env:
          PR_TITLE: ${{ env.PR_TITLE }}
          PR_DESCRIPTION: ${{ env.PR_DESCRIPTION }}
      - name: Push Data to Confluence
        run: |
          PAGE_ID="393217"
          TABLE_CONTENT="||Title||Description||\n|${{ env.PR_TITLE }}|${{ env.PR_DESCRIPTION }}|"

          curl -s -u jadhavabhijeet6411@gmail.com:ATCTT3xFfGN0WHYhd7CwzYf5_A-14HswfpRlvoI0qL16_j_s0j2NDtwYKaXlSgGdfDubusiS-ujOxEsQUDWtUR2AF-Wny3I_F3hbNci2KsekO8dBgM1xSTFbU4BL9tV1j4WCTUvjQUuDkKZFoDHNqpljFkOCM5t9PvWSOMkfScd2pwo6orTe8YA=15D94BAD \
            -X PUT \
            -H "Content-Type: application/json" \
            -d '{
               "version": {
                 "number": 1
                  },
               "title": "PR requests",
               "type": "page",
               "body": {
                 "storage": {
                 "value": "<table>${TABLE_CONTENT}</table>",
                 "representation": "storage"
                 }
               }
            }' \
          https://demo-sw.atlassian.net/wiki/rest/api/content/393217
